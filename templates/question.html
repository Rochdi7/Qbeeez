{% extends "base.html" %}
{% load i18n static %}

{% block title %} {{ quiz.title }} | Qbeeez QCM {% endblock %}
{% block description %} {{ quiz.title }} - {{ quiz.description }} {% endblock %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
        <li class="breadcrumb-item"><a href="/">Accueil</a></li>
        <li class="breadcrumb-item"><a href="{% url 'programs' %}">Semestre</a></li>
        <li class="breadcrumb-item"><a href="{% url 'program_detail' course.program.id %}">{{ course.program }}</a></li>
        <li class="breadcrumb-item"><a href="{{ course.get_absolute_url }}">{{ course }}</a></li>
        <li class="breadcrumb-item"><a href="{% url 'quiz_index' course.slug %}">Quizzes</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ quiz.title|title }}</li>
    </ol>
</nav>

<div class="title-1">{{ quiz.title|title|truncatechars:25 }}</div>
<br>

<!-- Buttons Container -->
<div class="button-container">

    <!-- Take Notes Button -->
    <button class="btn custom-btn info" onclick="goToNotesSection()" id="take-notes-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="white">
            <path d="M12 2C6.48 2 2 6.48 2 12c0 5.52 4.48 10 10 10 1.78 0 3.44-.47 4.88-1.29l3.69 3.69c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41l-3.69-3.69C21.53 15.44 22 13.78 22 12c0-5.52-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM10 9h4v2h-4zm0 4h4v2h-4z"/>
        </svg>
    </button>
    <!-- Settings Button -->
    <button id="settings-btn" class="btn custom-btn info" onclick="openNav()">
        <i class="fas fa-cog"></i>
    </button>
    
    <!-- Guide Button -->
    <button id="guide-btn" class="btn custom-btn info">
        <i class="fa-solid fa-question-circle"></i>
    </button>
    
    <!-- Exit Button -->
    {% if question %}
        <a id="exit-btn" href="{% url 'quiz_index' course.slug %}" class="btn custom-btn danger">
            <i class="fa-solid fa-sign-out-alt"></i>
        </a>
    {% endif %}
</div>


<div class="container">
    <!-- Exam Mode Toggle Button -->
    <form method="POST" action="">
        {% csrf_token %}

    </form>
    <br>

    <div id="fullScreenWrapper" class="full-screen-wrapper">
        {% if previous.answers and not exam_mode %}
            <h3 class="text-center">{% trans "La question précédente" %}:</h3>
            <h4 class="text-center">{{ previous.previous_question }}</h4>
    
            <div class="response-wrapper">
                {% if previous.previous_outcome %}
                    <div class="alert alert-success">
                {% else %}
                    <div class="alert alert-warning">
                {% endif %}
                <p class="answer-response">
                    {% trans "Votre réponse était" %} 
                    <span>{{ previous.previous_outcome|yesno:"correcte,incorrecte" }}</span>
                </p>
                </div> <!-- Fermeture de la div d'alerte -->
            </div> <!-- Fermeture de la div response-wrapper -->
    
            {% if previous.answers %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <tbody>
                            {% for answer in previous.answers %}
                                <tr class="{% if answer.correct %}table-success{% else %}table-danger{% endif %}">
                                    <td>{{ answer }}</td>
                                    {% if quiz.is_exam %}
                                        <td>{% trans "Votre réponse ne sera pas affichée en mode examen." %}</td>
                                    {% else %}
                                        <td>
                                            {% if previous.question_type.MCQuestion %}
                                                {% if answer.id|add:"0" == previous.previous_answer|add:"0" %}
                                                    {% trans "C'était votre réponse." %}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> <!-- Fermeture de la div responsive -->
            {% endif %}
    
            <p class="explanation-title"><strong>{% trans "Explication" %}:</strong></p>
            <p class="p-2 explanation-content" style="background-color: #fcf8e3;">
              {% if previous.previous_question.explanation %}
                {{ previous.previous_question.explanation }}
              {% else %}
                {% trans "Aucune explication définie pour cette question." %}
              {% endif %}
            </p>
        {% endif %}
    
        {% if question %}
            {% if progress.0|add:1 == 1 %}
                <div class="modal fade show" id="instractionModal" tabindex="-1" aria-labelledby="instractionModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="instractionModalLabel">Instructions du quiz</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                            </div>
                            <div class="modal-body">
                                Vous ne pouvez pas revenir à la question précédente après l'avoir soumise, 
                                alors vérifiez votre réponse avant de passer à la suivante !
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn custom-btn primary" data-bs-dismiss="modal">Compris</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
    
            {% if progress %}
                <div class="text-light rounded small px-2 bg-danger" style="float: right;">
                    {% trans "Question" %} {{ progress.0|add:1 }} {% trans "sur" %} {{ progress.1 }}
                </div>
            {% endif %}
    
            <p>
                <small class="muted">{% trans "Catégorie du quiz" %}:</small>
                <strong>{{ quiz.category }}</strong>
            </p>
    
            <div class="card relative">
                <div class="lead p-2">{{ question.content }}</div>
    
                {% if question.figure %}
                    <div class="col-md-8 mx-auto">
                        <img class="q-img" src="{{ question.figure.url }}" alt="{{ question.content }}" />
                    </div>
                {% endif %}
    
                <div class="card-subtitle p-4">
                
                    <div id="questionContent" class="question-content">
                        <form action="" method="POST">{% csrf_token %}
                            <input type="hidden" name="question_id" value="{{ question.id }}">
                
                            <ul class="list-group">
                                {% for answer in form.answers %}
                                    <li class="list-group-item">
                                        {{ answer }}
                                    </li>
                                {% endfor %}
                            </ul>
                            <br>
                            <input type="hidden" name="question_id" value="{{ previous.question.id }}">
                            <button type="submit" name="previous_question" class="btn custom-btn secondary">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 19L8 12L15 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <input type="submit" value="{% trans 'Correction' %}" class="btn custom-btn primary" />
                
                            <input type="hidden" name="question_id" value="{{ question.id }}">
                            <button type="submit" name="next_question" class="btn custom-btn primary">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M9 5L16 12L9 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                
                            <button type="submit" name="toggle_exam_mode" class="btn custom-btn warning">
                                {% if exam_mode %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square" viewBox="0 0 16 16">
                                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zm-1 1H2v12h12V2z"/>
                                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                    {% trans "Mode Examen" %}
                                {% else %}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                        <path d="M15.502 1.94a.5.5 0 0 1 0 .706l-1 1a.5.5 0 0 1-.707 0L10.5 1.707a.5.5 0 0 1 0-.707l1-1a.5.5 0 0 1 .707 0l3.294 3.293z"/>
                                        <path d="M13.5 3.207L10.793.5l-9.56 9.56a.5.5 0 0 0-.121.196l-1 4a.5.5 0 0 0 .605.605l4-1a.5.5 0 0 0 .196-.12l9.56-9.56zM1 13.5V16h2.5l9.293-9.293-2.5-2.5L1 13.5z"/>
                                        <path fill-rule="evenodd" d="M1 13.5V16h2.5l9.293-9.293-2.5-2.5L1 13.5zm2.5 0L1 16h2.5v-2.5z"/>
                                    </svg>
                                    {% trans "Mode Examen" %}
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>
    


 <!-- Question Info Section -->
<div class="question-info p-4 bg-light">
    <i class="fa-solid fa-chevron-up text-[#4D4D4D] cursor-pointer" title="Hide Question Info" onclick="toggleQuestionInfo(this)"></i>
    <div class="question-details hidden"> <!-- Maintain the flex properties here -->
        <span class="block border-radius-class">{{ question.year }}</span>
        <span class="block border-radius-class">{{ question.question_type }}</span>
        <span class="block border-radius-class">{{ question.correction_type }}</span>
    </div>
</div>


<style>

</style>
<!-- Timer Section -->
<div id="timer">
    <p>
        <h4>Temps écoulé :<span id="timer-display">00:00</span></h4> 
    </p>
    <div class="button-container">
        <button id="pause-btn" class="btn">
            <!-- SVG for Pause icon -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="4" width="4" height="16" fill="currentColor"/>
                <rect x="14" y="4" width="4" height="16" fill="currentColor"/>
            </svg>
        </button>
        
        <button id="resume-btn" class="btn">
            <!-- SVG for Resume icon (Play icon) -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 5v14l11-7L8 5z" fill="currentColor"/>
            </svg>
        </button>
        
        <button id="reset-timer" class="btn">
            <!-- SVG for Reset icon (Circular arrow icon) -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 4V1L8 5l4 4V6c3.3 0 6 2.7 6 6s-2.7 6-6 6-6-2.7-6-6H3c0 5 4 9 9 9s9-4 9-9-4-9-9-9z" fill="currentColor"/>
            </svg>
        </button>
        
    </div>
</div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mt-3">
            {% if previous.question %}
                <form method="POST" action="">
                    {% csrf_token %}
                    <!-- Navigation Buttons can go here if needed -->
                </form>
            {% endif %}

            {% if not exam_mode %}
                <form method="POST" action="">
                    {% csrf_token %}
                    <!-- Navigation Buttons can go here if needed -->
                </form>
            {% endif %}
        </div>
    {% endif %}

    {% include 'quiz/slide.html' %}

    {% include 'guide_modal.html' %}
</div>


<a href="{% url 'question_detail' question_id=question.id %}">
            <div class="btn-trigger">
                <i class="fa-solid fa-comments text-3xl"></i>
            </div>
        </a>

<!-- Toggleable Notes Section -->
<div id="notesSection" class="notes-section" style="display: none;">
    <div class="note-taking-section p-4 bg-light">
        <h5>Take Notes:</h5>
        <form id="save-notes-form" action="{% url 'save_notes' quiz.id question.id %}" method="POST">
            {% csrf_token %}
            <textarea name="notes" class="form-control" rows="4" placeholder="Write your notes here...">{{ user_notes }}</textarea>
            <br>
            <button type="submit" class="btn custom-btn primary">Save Notes</button>
        </form>

        <!-- Display saved notes if they exist -->
        <div id="notesDisplay" style="display: {% if user_notes %}block{% else %}none{% endif %};">
            <h6>Your Notes:</h6>
            <ul id="notesList" class="list-unstyled">
                {% for note in notes %}
                    <li id="note-{{ note.id }}" class="note-item">
                        <p>{{ note.notes }}</p> <!-- Display the notes content -->
                        <small>Created at: {{ note.created_at }}</small>
                        <button class="btn btn-link edit-note" data-id="{{ note.id }}" data-notes="{{ note.notes }}">🖉 Edit</button>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<script>
function goToNotesSection() {
    const notesSection = document.getElementById('notesSection');

    // Check if the notes section is currently hidden
    if (notesSection.style.display === 'none' || notesSection.style.display === '') {
        notesSection.style.display = 'block'; // Show the section
        notesSection.scrollIntoView({ behavior: 'smooth' }); // Scroll to the section
    } else {
        notesSection.style.display = 'none'; // Hide the section
    }
}
</script>
<!-- Include the notes.js file -->
<link rel="stylesheet" href="{% static 'css/guide-modal.css' %}">
<link rel="stylesheet" href="{% static 'css/note.css' %}">
<link rel="stylesheet" href="{% static 'css/addcustom.css' %}">
<link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
<link rel="stylesheet" href="{% static 'css/Settings.css' %}">
<link rel="stylesheet" href="{% static 'css/custom.css' %}"> <!-- Link to your custom CSS file -->

<script src="{% static 'js/timer.js' %}"></script>
<script src="{% static 'js/note.js' %}"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

{% endblock %}
